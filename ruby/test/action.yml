name: 'Tests - rspec'
description: 'Runs tests using rspec'
inputs:
  DB_PORT:
    description: Database port
    default: 3306
  DB_HOST:
    description: Database host
    default: mysql
  
runs:
  using: "composite"
  steps:
    - name: Restoring workspace from cache
      uses: wishabi/github-actions/cache@v0
    - name: Execute rspec tests
      shell: bash
      run: |
           bundle exec rails db:create db:migrate
           bundle exec rspec --format progress --format RspecJunitFormatter -o result/rspec.xml
      env:
        RAILS_ENV: test
        DB_PORT: ${{ inputs.DB_PORT }}
        DB_HOST: ${{ inputs.DB_HOST }}
        BUNDLE_DEPLOYMENT: true
    - name: Rename code coverage paths to be found by Sonarqube
      working-directory: ./coverage
      shell: bash
      run: |
        sed -i 's@'$GITHUB_WORKSPACE'@/github/workspace/@g' coverage.json
    - name: 'Upload coverage'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.sha }}-coverage.out
        path: ./coverage/coverage.json
        retention-days: 1
    - name: 'Upload test results'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ github.sha }}-test-report.out
        path: ./result/rspec.xml
        retention-days: 1
