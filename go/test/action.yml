name: 'go-test'
description: 'Custom GitHub action that runs all Golang tests within a repository and saves the test + coverage reports as artifacts'

inputs:
  TAGS:
    description: Set of tags to run tests with.
    required: false
  TIMEOUT:
    description: A timeout value. If tests take longer than this, they will fail. Set to an empty string to disable.
    required: false
    default: "30"
  GO_MOD_DIRECTORY:
    description: Directory containing the go.mod and go.sum file
    required: false
    default: .

runs:
  using: 'composite'
  steps:
    - name: Running go tests
      working-directory: ${{ inputs.GO_MOD_DIRECTORY }}
      shell: bash
      run: ${GITHUB_ACTION_PATH}/test.sh "${{ inputs.TAGS }}" "${{ inputs.TIMEOUT }}"
    - name: Move coverage
      shell: bash
      run: |
        if [ ${{ inputs.GO_MOD_DIRECTORY }} != "." ]; then
          mv ${{ inputs.GO_MOD_DIRECTORY }}/test-report.out ./test-report.out
          mv ${{ inputs.GO_MOD_DIRECTORY }}/coverage.out ./coverage.out
        fi
    - name: Uploading test report
      uses: actions/upload-artifact@v3
      with:
        name: "${{ github.sha }}-test-report.out"
        path: "./test-report.out"
        retention-days: 1
    - name: Uploading coverage report
      uses: actions/upload-artifact@v3
      with:
        name: "${{ github.sha }}-coverage.out"
        path: "./coverage.out"
        retention-days: 1
